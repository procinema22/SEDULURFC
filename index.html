<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SEDULUR FOTOCOPY ‚Äî Kolase Foto A4</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<style>
:root {
  --bg:#f4f7fb; --card:#fff; --text:#0f1720; --muted:#6b7280; --accent:#4F46E5;
}
.dark {
  --bg:#0b1220; --card:#0f1720; --text:#e6eef8; --muted:#9aa7bf; --accent:#6366F1;
}
html, body {margin:0; font-family:"Poppins", sans-serif; background:var(--bg); color:var(--text);}
.wrap {max-width:1100px; margin:20px auto; padding:20px;}
header {display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;}
h1 {font-size:20px; margin:0;}
.card {background:var(--card); border-radius:12px; padding:16px; box-shadow:0 4px 16px rgba(0,0,0,0.05);}
.controls {display:flex; flex-direction:column; gap:10px;}
label {font-size:13px; color:var(--muted);}
input, select {padding:6px 8px; border-radius:8px; border:1px solid #ddd; min-width:90px;}
button {border:none; border-radius:10px; padding:8px 14px; cursor:pointer; font-weight:600; transition:0.25s;}
.download-btn {background: linear-gradient(135deg, #4F46E5, #9333EA); box-shadow:0 4px 12px rgba(147,51,234,0.4); color:#fff;}
.download-btn:hover {transform:translateY(-2px) scale(1.03);}
.warn {background:#ef4444; color:#fff;}
.ok {background:var(--accent); color:#fff;}
.ghost {background:transparent; border:1px solid #888; color:var(--text);}
.ghost:hover {background:rgba(99,102,241,0.1);}
main {display:grid; grid-template-columns:360px 1fr; gap:20px;}
#canvas {width:100%; max-width:595px; border-radius:10px; background:white; box-shadow:0 4px 20px rgba(0,0,0,0.08);}
.price {font-weight:600; color:var(--accent); font-size:16px; margin-top:6px;}
#batchList {max-height:200px; overflow-y:auto;}
@media print {.no-print {display:none;}}
</style>
</head>

<body>
<div class="wrap">
  <header class="no-print">
    <h1>üñ®Ô∏è SEDULUR FOTOCOPY ‚Äî Kolase Foto A4</h1>
    <button id="toggleDark" class="ghost">üåô Mode Gelap</button>
  </header>

  <main>
    <!-- Panel kiri -->
    <section class="card no-print">
      <div class="controls">
        <label>Unggah Foto:</label>
        <input type="file" id="upload" accept="image/*" multiple />

        <label>Pilih Ukuran (cm):</label>
        <select id="sizeSelect">
          <option value="2x3">2x3</option>
          <option value="3x4">3x4</option>
          <option value="4x6">4x6</option>
          <option value="5x5">5x5</option>
          <option value="6x9">6x9</option>
          <option value="10x15">10x15 (4R)</option>
          <option value="custom">Custom...</option>
        </select>

        <div id="customSize" style="display:none;gap:6px;align-items:center;">
          <input type="number" id="customW" placeholder="Lebar (cm)" style="width:100px;">
          <input type="number" id="customH" placeholder="Tinggi (cm)" style="width:100px;">
          <button id="addCustom" class="ok">‚ûï Add Custom</button>
        </div>

        <label>Atur Margin (px):</label>
        <input type="number" id="margin" value="20" />

        <label>Atur Jarak/Gep antar foto (px):</label>
        <input type="number" id="gap" value="10" />

        <label>Nama User:</label>
        <input type="text" id="userName" placeholder="Masukkan nama pengguna">

        <div class="price" id="priceDisplay">Harga: Rp 0</div>

        <label>Daftar Batch:</label>
        <div id="batchList"></div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
          <button class="ok" id="generate">üìÑ Buat Kolase</button>
          <button class="download-btn" id="downloadJpg">üñºÔ∏è Download JPG</button>
          <button class="download-btn" id="downloadPdf">üíæ Download PDF</button>
          <button class="download-btn" id="printNow">üñ®Ô∏è Print Langsung</button>
          <button class="warn" id="reset">üîÅ Reset</button>
        </div>
      </div>
    </section>

    <!-- Panel kanan -->
    <section class="card">
      <canvas id="canvas" width="2480" height="3508"></canvas>
    </section>
  </main>
</div>

<script>
const upload = document.getElementById('upload');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const generateBtn = document.getElementById('generate');
const marginInput = document.getElementById('margin');
const gapInput = document.getElementById('gap');
const priceDisplay = document.getElementById('priceDisplay');
const sizeSelect = document.getElementById('sizeSelect');
const userName = document.getElementById('userName');
const toggleDark = document.getElementById('toggleDark');
const addCustom = document.getElementById('addCustom');
const batchList = document.getElementById('batchList');

let batches = [];

sizeSelect.addEventListener('change', ()=>{
  document.getElementById('customSize').style.display = sizeSelect.value === 'custom' ? 'flex' : 'none';
});

// Tambah batch
function addBatch(files, size, customW=0, customH=0){
  if(files.length === 0){
    alert("‚ùå Upload foto dulu sebelum menambahkan batch!");
    return;
  }
  batches.push({ files, size, customW, customH, copy: 1 });
  refreshBatchList();
  alert(`‚úÖ ${files.length} foto ditambahkan (${size}${size==='custom'?` ${customW}x${customH} cm`:""})`);
}

// Tampilkan daftar batch
function refreshBatchList(){
  batchList.innerHTML = "";
  batches.forEach((batch, index)=>{
    const w = batch.size === 'custom' ? batch.customW : batch.size.split('x')[0];
    const h = batch.size === 'custom' ? batch.customH : batch.size.split('x')[1];
    const div = document.createElement('div');
    div.style.display = "flex"; div.style.alignItems = "center"; div.style.gap = "6px";

    const info = document.createElement('span');
    info.textContent = `${batch.files.length} foto ‚Äî ${w}x${h} cm`;

    const copyInput = document.createElement('input');
    copyInput.type = "number"; copyInput.value = batch.copy || 1; copyInput.min = 1;
    copyInput.style.width = "60px";
    copyInput.addEventListener('change', ()=> batch.copy = parseInt(copyInput.value));

    const delBtn = document.createElement('button');
    delBtn.textContent = "‚ùå"; delBtn.className="warn";
    delBtn.onclick = ()=> { batches.splice(index,1); refreshBatchList(); };

    div.appendChild(info);
    div.appendChild(copyInput);
    div.appendChild(delBtn);
    batchList.appendChild(div);
  });
}

// Upload file (preset)
upload.addEventListener('change', e=>{
  const files = Array.from(e.target.files);
  const currentSize = sizeSelect.value;
  if(currentSize !== 'custom'){
    addBatch(files, currentSize);
  }
});

// Tombol Add Custom
addCustom.addEventListener('click', ()=>{
  const customW = parseFloat(document.getElementById('customW').value);
  const customH = parseFloat(document.getElementById('customH').value);
  if(isNaN(customW) || isNaN(customH) || customW <=0 || customH <=0){
    alert("‚ùå Masukkan ukuran valid!");
    return;
  }
  const files = Array.from(upload.files);
  addBatch(files, 'custom', customW, customH);
});

// Generate Kolase
generateBtn.addEventListener('click', async ()=> {
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const margin = parseInt(marginInput.value);
  const gap = parseInt(gapInput.value);
  const pxPerCm = 118;
  let x = margin, y = margin, maxHeight = 0;
  let totalHarga = 0;
  const areaA5 = 148*118 * 210*118;

  for (const batch of batches) {
    let wcm,hcm;
    if(batch.size === 'custom'){
      wcm = batch.customW; hcm = batch.customH;
    } else {
      [wcm,hcm] = batch.size.split('x').map(Number);
    }
    const photoW = wcm * pxPerCm;
    const photoH = hcm * pxPerCm;

    for (const file of batch.files) {
      const img = await loadImageWithEXIF(file);
      let drawW = photoW, drawH = photoH;
      if(img.width > img.height && photoH > photoW) [drawW, drawH] = [photoH, photoW];
      const ratio = Math.min(drawW / img.width, drawH / img.height);
      const dw = img.width * ratio;
      const dh = img.height * ratio;
      const offsetX = (drawW - dw)/2;
      const offsetY = (drawH - dh)/2;

      for(let c=0;c<(batch.copy||1);c++){
        ctx.drawImage(img, x + offsetX, y + offsetY, dw, dh);
        x += drawW + gap;
        maxHeight = Math.max(maxHeight, drawH);
        const fotoArea = drawW*dh;
        totalHarga += fotoArea > areaA5 ? 2000 : 1000;
        if(x + drawW > canvas.width - margin){ x = margin; y += maxHeight + gap; maxHeight=0; }
      }
    }
  }

  priceDisplay.textContent = `Harga: Rp ${totalHarga.toLocaleString()}`;
  ctx.font = "36px Poppins";
  ctx.fillStyle = "#333";
  ctx.fillText(`Nama: ${userName.value || "-"}`, 100, canvas.height - 120);
  ctx.fillText(`Harga: Rp ${totalHarga}`, 100, canvas.height - 60);
});

// Reset
document.getElementById('reset').onclick = ()=> {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  batches = [];
  priceDisplay.textContent = "Harga: Rp 0";
  refreshBatchList();
};

// Download JPG
document.getElementById('downloadJpg').onclick = ()=> {
  const link = document.createElement('a');
  link.download = 'hasil_kolase.jpg';
  link.href = canvas.toDataURL("image/jpeg");
  link.click();
};

// Download PDF
document.getElementById('downloadPdf').onclick = ()=> {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  pdf.addImage(canvas.toDataURL("image/jpeg"), 'JPEG', 0, 0, 595, 842);
  pdf.save('hasil_kolase.pdf');
};

// Print langsung
document.getElementById('printNow').onclick = ()=> {
  const win = window.open('');
  win.document.write('<img src="'+canvas.toDataURL('image/png')+'" style="width:100%">');
  win.document.close();
  win.focus();
  win.print();
  win.close();
};

// Dark mode
if(localStorage.getItem('theme')==='dark'){
  document.body.classList.add('dark');
  toggleDark.textContent = "‚òÄÔ∏è Mode Terang";
}
toggleDark.onclick = ()=>{
  document.body.classList.toggle('dark');
  const dark = document.body.classList.contains('dark');
  localStorage.setItem('theme', dark ? 'dark':'light');
  toggleDark.textContent = dark ? "‚òÄÔ∏è Mode Terang":"üåô Mode Gelap";
};

// Auto rotate EXIF
function loadImageWithEXIF(file){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = function(e){
      const img = new Image();
      EXIF.getData(file, function(){
        const orientation = EXIF.getTag(this, "Orientation");
        img.onload = function(){
          const c = document.createElement('canvas');
          const cx = c.getContext('2d');
          if(orientation>=5 && orientation<=8){ c.width=img.height; c.height=img.width; } 
          else { c.width=img.width; c.height=img.height; }
          switch(orientation){
            case 3: cx.rotate(Math.PI); cx.drawImage(img,-img.width,-img.height); break;
            case 6: cx.rotate(0.5*Math.PI); cx.drawImage(img,0,-img.height); break;
            case 8: cx.rotate(-0.5*Math.PI); cx.drawImage(img,-img.width,0); break;
            default: cx.drawImage(img,0,0);
          }
          const fixedImg = new Image();
          fixedImg.onload = ()=>resolve(fixedImg);
          fixedImg.src = c.toDataURL();
        };
        img.src = e.target.result;
      });
    };
    reader.readAsDataURL(file);
  });
}
</script>
</body>
</html>
